
@{
    ViewBag.Title = "Index";
}

<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>Publishers
                    <small>
                        <a href='@Url.Action("Create","Publisher")'><i class="fa fa-plus"></i>&nbsp; Create new </a>
                    </small>
                </h2> 
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div id="datatable-checkbox_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                    <div class="row">
                        <div class="col-sm-12" style="min-height:400px">
                            <table id="myTable" class="table table-striped table-bordered dataTable no-footer table-hover">
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script type="text/javascript">
        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : sParameterName[1];
                }
            }
        };

        $(document).ready(function () {
            $('#myTable').dataTable({
                serverSide: true,
                ajax: {url:'@Url.Action("Get", "Publisher")',
                        data:function ( d ) {
                            d.publisherStatuses = GetPublisherCombinedStatus();
                            d.isPotentiallyCancelled = IsPotentiallyCancelled();
                        }},
                columns: [
                    {
                        name: 'name',
                        data: 'name',
                        title: "Publisher",
                        sortable: true,
                        searchable: true
                    },
                    {
                        name: 'id',
                        data: "id",
                        title: "ID",
                        sortable: true,
                        searchable: false
                    },
                    {
                        name: 'state',
                        data: "state",
                        title: "State",
                        sortable: true,
                        searchable: false
                    },
                    {
                        name: 'category',
                        data: "category",
                        title: "Category",
                        sortable: true,
                        searchable: false
                    },
                    {
                        name: null,
                        data: null,
                        title: '',
                        sortable: false,
                        searchable: false,
                        defaultContent: "<a class='subscribeBtn' href='#'><i class='fa fa-envelope-o'></i> Subscribe</a> <a class='detailsBtn' href='#'><i class='fa fa-info'></i> Details</a>"
                    }
                ]
            });
            $('#myTable').on('draw.dt', function () {
                initButtons();
                addCustomFilters();
            });

            function initButtons() {
                var table = $('#myTable').DataTable();

                $(".subscribeBtn").click(function () {
                    var table = $('#myTable').DataTable();
                    window.location.href = '@Url.Action("index", "Subscription")' + '?publisherId=' + table.row($(this).parents('tr')).data().id;
                });

                $(".detailsBtn").click(function () {
                    var table = $('#myTable').DataTable();
                    window.location.href = '@Url.Action("Details", "Publisher")' + '?publisherId=' + table.row($(this).parents('tr')).data().id;
                });
            }

            function GetPublisherCombinedStatus(){
                var combinedStatus = 0;
                if(!$('#publisherStatus').length)
                {
                    var urlParameter = getUrlParameter('publisherStatuses');
                    if(!!urlParameter)
                    {
                        combinedStatus = urlParameter;
                    }
                    return combinedStatus;
                }
                $.each($('#publisherStatus option:selected'),function(index,value){
                    combinedStatus |=value.value;
                });
                return combinedStatus;
            }

            function IsPotentiallyCancelled()
            {
                var urlParameter = getUrlParameter('isPotentiallyCancelled');
                return !!urlParameter;
            }

            function addCustomFilters()
            {
                if(!!$("#customTableFilter").length)
                {
                    return;
                };
                var select = '<label id="customTableFilter"> Status: <select id="publisherStatus" multiple="multiple">';
                var selectedStatuses = getUrlParameter('publisherStatuses'); 
                $.each(@Html.Raw(ViewBag.StatusList), function( index, value ) {
                    var selected = '';
                    if(!!selectedStatuses && ((selectedStatuses&value.Item2)>0))
                    {
                        selected="selected='selected'";
                    }
                    select+="<option value='"+value.Item2+"' " + selected + ">"+value.Item1 +"</option>";
                });
                select +="</select></label>";
                $("#myTable_filter").prepend(select);
                $('#publisherStatus').multiselect();
                $("#publisherStatus").change(function(){
                    $('#myTable').DataTable().draw();
                })
            }
        });
    </script>
    }
