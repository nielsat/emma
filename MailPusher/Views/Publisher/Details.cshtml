@model MailPusher.Models.Publisher
@{
    ViewBag.Title = Model.Name;
}
<div class="row">
    <div class="col-md-12" id="publisherEmailsContainer">
        <div class="row" id="publisherInfoContainer">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>Publisher - @Model.Name (ID - @Model.ID)</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <label>Domain</label><br />
                            <a href="@Model.Domain" target="_blank"> @Model.Domain</a>
                        </div>
                        <div class="col-md-3">
                            <label>Language</label><br />
                            @Model.Language
                        </div>
                        <div class="col-md-3">
                            <label>Category</label><br />
                            @Model.Category
                        </div>
                        <div class="col-md-3">
                            <label>State</label><br />
                            @Model.FormatedStatus
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="publisherEmails">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>
                            @Model.Name emails
                        </h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <div id="datatable-checkbox_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                            <div class="row">
                                <div class="col-sm-12" id="myTableContainer">
                                    <table id="myTable" class="table table-striped table-bordered dataTable no-footer table-hover"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8" id="rightEmailContainer">
        @Html.Partial("Custom/SingleEmail")
    </div>
</div>

@section Scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            $('#myTable').dataTable({
                serverSide: true,
                ajax:{
                    url:'@Url.Action("Get", "Email")',
                    data: function ( d ) {
                        d.publisherID =@Model.ID;
                        if(!!$("#emailMinDate").length && !!$("#emailMaxDate").length){
                            d.from = $("#emailMinDate").data('datepicker').getFormattedDate('mm-dd-yyyy');
                            d.to = $("#emailMaxDate").data('datepicker').getFormattedDate('mm-dd-yyyy');
                        }else{
                            d.from=null;
                            d.to=null;
                        }
                    }
                },
                columns: [
                    {
                        name: 'subjectLine',
                        data: 'subjectLine',
                        title: "Subject",
                        sortable: true,
                        searchable: true
                    },
                    {
                        name: 'id',
                        data: "id",
                        title: "ID",
                        sortable: true,
                        searchable: false,
                        visible: false,
                    },
                    {
                        name: 'senderAddress',
                        data: "senderAddress",
                        title: "Sender Address",
                        sortable: true,
                        searchable: false,
                        visible: false,
                    },
                    {
                        name: 'copy',
                        data: "copy",
                        title: "Copy",
                        sortable: true,
                        searchable: false,
                        visible: false,
                    },
                    {
                        name: 'receivedGMT',
                        data: "receivedGMT",
                        title: "Sent",
                        sortable: true,
                        searchable: false,
                        width:260
                    },
                    {
                        name: 'shortReceivedGMT',
                        data: "shortReceivedGMT",
                        title: "Sent",
                        sortable: true,
                        searchable: false,
                        width:220,
                        visible: false,
                    },
                    {
                        name: 'btns',
                        data: null,
                        title: '',
                        sortable: false,
                        searchable: false,
                        defaultContent: "<div class='btnTD'></div><a class='emailPermalink' href='#' title='open in new window'><i class='fa fa-link'></i> </a>",
                    }
                ],
                "iDisplayLength": 100,
                "bLengthChange": false,
                "oLanguage": {
                    "sSearch": "Search emails by subject line:&nbsp;&nbsp;"
                },
                "order": []
            });
            $('#myTable').on('draw.dt', function (e, settings) {
                initButtons();
                changeGridStyle(settings);
            });

            function changeGridStyle(settings)
            {
                gridHelper.updateContainerHeight('myTableContainer','myTable', 200);
                gridHelper.changeTdCursorToPointer('myTable','noClass');
                gridHelper.hidePginationIfOnePage('myTable',settings);
            }

            function initButtons() {
                var table = $('#myTable').DataTable();
                $(".emailPermalink").click(function(){
                    var table = $('#myTable').DataTable();
                    window.open('@Url.Action("Index", "Email")' + '?id=' + table.row($(this).parents('tr')).data().id, '_blank')
                });

                $("#myTable td").click(function(){
                    if(!$(this).find("div.btnTD").length)
                    {
                        //INIT
                        var rowData =table.row(this).data();
                        singleEmailHelper.init(rowData,'@Url.Action("GetEmailBody", "Email")', 'publisherInfoContainer','topNavMenu');

                        //STYLE
                        $(".selectedTdItem").removeClass("selectedTdItem");
                        $("#publisherEmailsContainer").removeClass("col-md-12").addClass("col-md-5");
                        $("#myTableContainer").height($('#myTable').height()+200);
                        var parentTr =$(this).parent("tr");
                        parentTr.addClass('selectedTdItem');
                        $(".dataTables_filter .form-control").addClass('full-width-important');
                        table.column("btns:name").visible(false);
                        table.column("receivedGMT:name").visible(false);
                        table.column("shortReceivedGMT:name").visible(true);

                        //FOCUS
                        if(!Utils.isElementInView(parentTr)){
                            var rowpos = $(parentTr).offset();
                            $(window).scrollTop(rowpos.top-200);
                        }
                    }
                });
            }
            $("#backToEmailsView").click(function(){
                var selectedRow = $(".selectedTdItem");

                $("#publisherEmailsContainer").removeClass("col-md-5").addClass("col-md-12");
                $(".dataTables_filter .form-control").removeClass('full-width-important');
                var table = $('#myTable').DataTable();
                table.column("btns:name").visible(true);
                table.column("receivedGMT:name").visible(true);
                table.column("shortReceivedGMT:name").visible(false);

                singleEmailHelper.hide();
                if(!Utils.isElementInView(selectedRow)){
                    var rowpos = selectedRow.offset();
                    $(window).scrollTop(rowpos.top-200);
                }
            });

            function addCustomFilters()
            {
                if(!!$("#emailMinDate").length)
                {
                    return;
                };
                var emailRange = '<label > From: <input type="text" id="emailMinDate" class="form-control input-sm"/></label> &nbsp;';
                emailRange += '<label > To: <input type="text" id="emailMaxDate" class="form-control input-sm"/></label> &nbsp;';
                $("#myTable_filter").prepend(emailRange);
                $("#emailMinDate").datepicker();
                $("#emailMaxDate").datepicker();
                $('#emailMinDate').change(function(){
                    $('#myTable').DataTable().draw();
                });
                $('#emailMaxDate').change(function(){
                    $('#myTable').DataTable().draw();
                });
            }

            $('div.dataTables_filter input').addClass('form-control');
            $("#myTable").css({'width':'100%'});
        });
    </script>
}